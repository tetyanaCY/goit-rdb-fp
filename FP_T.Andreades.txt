CREATE SCHEMA pandemic;
-- –°—Ç–≤–æ—Ä—ñ—Ç—å —Å—Ö–µ–º—É pandemic —É –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é SQL-–∫–æ–º–∞–Ω–¥–∏.

-- –û–±–µ—Ä—ñ—Ç—å —ó—ó —è–∫ —Å—Ö–µ–º—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é SQL-–∫–æ–º–∞–Ω–¥–∏.
Use pandemic;

Use pandemic;

select * from pandemic.infectious_cases
limit 50
-- –ü—Ä–æ–¥–∏–≤—ñ—Ç—å—Å—è –¥–∞–Ω—ñ, —â–æ–± –±—É—Ç–∏ —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ.


-- 2. –ù–æ—Ä–º–∞–ª—ñ–∑—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—é infectious_cases –¥–æ 3—ó –Ω–æ—Ä–º–∞–ª—å–Ω–æ—ó —Ñ–æ—Ä–º–∏. –ó–±–µ—Ä–µ–∂—ñ—Ç—å —É —Ü—ñ–π –∂–µ —Å—Ö–µ–º—ñ –¥–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ –∑ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏.
Use pandemic;
select max(Length(Entity)), max(length(Code)) from pandemic.infectious_cases;

create table if not exists country
(
id int auto_increment primary key,
entity varchar(34) not null,
code varchar(8) not null
);

insert into country (entity, code)
select distinct entity, code from infectious_cases;

select count(*), count(distinct entity, code) from country;

select count(distinct entity, code) from infectious_cases;

--

create table infectious_cases_norm like infectious_cases;

alter table infectious_cases_norm
add column country_id int first;

alter table infectious_cases_norm
drop column Entity,
drop column Code;

alter table infectious_cases_norm
add constraint infectious_cases_norm_country_fk
foreign key (country_id) references country(id);














select * from infectious_cases_norm;

show create table infectious_cases;

alter table infectious_cases_norm
add column inf_id int auto_increment primary key first;


insert into infectious_cases_norm
(
  `country_id`,
  `Year`,
  `Number_yaws`,
  `polio_cases`,
  `cases_guinea_worm`,
  `Number_rabies`,
  `Number_malaria`,
  `Number_hiv` ,
  `Number_tuberculosis`,
  `Number_smallpox` ,
  `Number_cholera_cases` 
)
(
select
  `id`,
  `Year`,
  `Number_yaws`,
  `polio_cases`,
  `cases_guinea_worm`,
  `Number_rabies`,
  `Number_malaria`,
  `Number_hiv` ,
  `Number_tuberculosis`,
  `Number_smallpox` ,
  `Number_cholera_cases` 
from infectious_cases
inner join country on infectious_cases.Entity= country.entity and infectious_cases.Code= country.Code
);




select * from infectious_cases_norm;

-- 3. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π—Ç–µ –¥–∞–Ω—ñ:
-- –î–ª—è –∫–æ–∂–Ω–æ—ó —É–Ω—ñ–∫–∞–ª—å–Ω–æ—ó –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó Entity —Ç–∞ Code –∞–±–æ —ó—Ö id –ø–æ—Ä–∞—Ö—É–π—Ç–µ —Å–µ—Ä–µ–¥–Ω—î, –º—ñ–Ω—ñ–º–∞–ª—å–Ω–µ, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞ —Å—É–º—É –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞ Number_rabies.
-- üí° –í—Ä–∞—Ö—É–π—Ç–µ, —â–æ –∞—Ç—Ä–∏–±—É—Ç Number_rabies –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äò‚Äô ‚Äî –≤–∞–º –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ —ó—Ö –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏.
-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥—Å–æ—Ä—Ç—É–π—Ç–µ –∑–∞ –ø–æ—Ä–∞—Ö–æ–≤–∞–Ω–∏–º —Å–µ—Ä–µ–¥–Ω—ñ–º –∑–Ω–∞—á–µ–Ω–Ω—è–º —É –ø–æ—Ä—è–¥–∫—É —Å–ø–∞–¥–∞–Ω–Ω—è.
-- –û–±–µ—Ä—ñ—Ç—å —Ç—ñ–ª—å–∫–∏ 10 —Ä—è–¥–∫—ñ–≤ –¥–ª—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è –Ω–∞ –µ–∫—Ä–∞–Ω.

USE pandemic;

SELECT country_id,
       AVG(Number_rabies) AS average,
       MIN(Number_rabies) AS minimal,
       MAX(Number_rabies) AS maximal,
       SUM(Number_rabies) AS sum
FROM infectious_cases_norm
WHERE Number_rabies IS NOT NULL
  AND Number_rabies <> ''
GROUP BY country_id
ORDER BY average DESC
LIMIT 10;



-- 4. –ü–æ–±—É–¥—É–π—Ç–µ –∫–æ–ª–æ–Ω–∫—É —Ä—ñ–∑–Ω–∏—Ü—ñ –≤ —Ä–æ–∫–∞—Ö.
--  –î–ª—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ—ó –∞–±–æ –Ω–æ—Ä–º–æ–≤–∞–Ω–æ—ó —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ Year –ø–æ–±—É–¥—É–π—Ç–µ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö SQL-—Ñ—É–Ω–∫—Ü—ñ–π:
-- –∞—Ç—Ä–∏–±—É—Ç, —â–æ —Å—Ç–≤–æ—Ä—é—î –¥–∞—Ç—É –ø–µ—Ä—à–æ–≥–æ —Å—ñ—á–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ —Ä–æ–∫—É,
-- –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –∞—Ç—Ä–∏–±—É—Ç –º—ñ—Å—Ç–∏—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äô1996‚Äô, —Ç–æ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞ –º–∞—î –±—É—Ç–∏ ‚Äò1996-01-01‚Äô.
-- –∞—Ç—Ä–∏–±—É—Ç, —â–æ –¥–æ—Ä—ñ–≤–Ω—é—î –ø–æ—Ç–æ—á–Ω—ñ–π –¥–∞—Ç—ñ,
-- –∞—Ç—Ä–∏–±—É—Ç, —â–æ –¥–æ—Ä—ñ–≤–Ω—é—î —Ä—ñ–∑–Ω–∏—Ü—ñ –≤ —Ä–æ–∫–∞—Ö –¥–≤–æ—Ö –≤–∏—â–µ–∑–≥–∞–¥–∞–Ω–∏—Ö –∫–æ–ª–æ–Ω–æ–∫.
-- –ü–µ—Ä–µ—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –≤—Å—ñ —ñ–Ω—à—ñ –∞—Ç—Ä–∏–±—É—Ç–∏, —Ç–∞–∫—ñ —è–∫ Number_malaria, –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.

Use pandemic;
select 
     Year, 
     makedate(Year,1) first_day,
     curdate(),
     timestampdiff(Year, makedate(Year,1), curdate()) as diff_years
from infectious_cases_norm;

alter table infectious_cases_norm
add column first_day date,
add column cur_day date,
add column diff_years int;

select year, first_day, diff_years from infectious_cases_norm;

update infectious_cases_norm set first_day=makedate(Year,1);


select @@sql_safe_updates;
select @@sql_safe_updates=0;


update infectious_cases_norm set first_day=makedate(Year,1);
select year, first_day, cur_day, diff_years from infectious_cases_norm;
update infectious_cases_norm set cur_day=curdate();
update infectious_cases_norm set diff_years=timestampdiff(Year, makedate(Year,1), curdate());


USE pandemic;

-- –ö—Ä–æ–∫ 1: –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é, —è–∫—â–æ –≤–æ–Ω–∞ –≤–∂–µ —ñ—Å–Ω—É—î
DROP FUNCTION IF EXISTS diff_years;

-- –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ü—ñ –≤ —Ä–æ–∫–∞—Ö
DELIMITER //

CREATE FUNCTION diff_years(num INT)
RETURNS INT
DETERMINISTIC
NO SQL
BEGIN
   -- –û–±—á–∏—Å–ª—é—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é –≤ —Ä–æ–∫–∞—Ö –º—ñ–∂ –¥–∞—Ç–æ—é 1 —Å—ñ—á–Ω—è —Ä–æ–∫—É (num) —ñ –ø–æ—Ç–æ—á–Ω–æ—é –¥–∞—Ç–æ—é
   RETURN TIMESTAMPDIFF(YEAR, MAKEDATE(num, 1), CURDATE());
END //

DELIMITER ;

-- –ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é, –≤–∏–±–∏—Ä–∞—é—á–∏ —Ä—ñ–∫ —ñ –æ–±—á–∏—Å–ª–µ–Ω—É —Ä—ñ–∑–Ω–∏—Ü—é –≤ —Ä–æ–∫–∞—Ö
SELECT Year, diff_years(Year) AS diff_years
FROM infectious_cases_norm;

-- –ö—Ä–æ–∫ 4: –î–æ–¥–∞—î–º–æ –Ω–æ–≤—É –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å —Ä—ñ–∑–Ω–∏—Ü—ñ –≤ —Ä–æ–∫–∞—Ö
ALTER TABLE infectious_cases_norm
ADD COLUMN diff_years2 INT;

-- –ö—Ä–æ–∫ 5: –û–Ω–æ–≤–ª—é—î–º–æ –Ω–æ–≤—É –∫–æ–ª–æ–Ω–∫—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å—Ç–≤–æ—Ä–µ–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é
UPDATE infectious_cases_norm
SET diff_years2 = diff_years(Year);

-- –ö—Ä–æ–∫ 6: –û—Ç—Ä–∏–º—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
SELECT Year, diff_years2
FROM infectious_cases_norm;
